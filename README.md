# Kaspi Bot

Приватный Telegram бот для работы с Kaspi.

## Установка и настройка

1. **Установите зависимости:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Создайте файл .env в корневой папке проекта:**
   ```
   BOT_TOKEN=your_bot_token_here
   ADMIN_ID=your_admin_id_here
   MONGO_URI=mongodb://localhost:27017/kaspi_bot
   KASPI_API=your_kaspi_api_here
   ```

3. **Получите токен бота:**
   - Напишите @BotFather в Telegram
   - Создайте нового бота командой `/newbot`
   - Скопируйте полученный токен в переменную `BOT_TOKEN`

4. **Получите ваш Telegram ID:**
   - Напишите @userinfobot в Telegram
   - Скопируйте ваш ID в переменную `ADMIN_ID`

5. **Получите API ключ Kaspi:**
   - Обратитесь в поддержку Kaspi для получения API ключа
   - Добавьте ключ в переменную `KASPI_API`

6. **Запустите бота:**
   ```bash
   python bot.py
   ```

## Команды

- `/start` - Запуск бота (доступно всем пользователям)
- Остальные функции доступны только администратору

## Функциональность

Бот подключается к реальному Kaspi API и:
- Отслеживает активные заказы в реальном времени
- Показывает уведомления о новых заказах
- Сохраняет данные в MongoDB (опционально)
- Отслеживает изменения цен товаров

## Статусы заказов (согласно документации Kaspi API)

### Статусы заказов:
- `APPROVED_BY_BANK` - продавец должен его принять
- `ACCEPTED_BY_MERCHANT` - принят (активные заказы)
- `COMPLETED` - завершен
- `CANCELLED` - отменен
- `CANCELLING` - в процессе отмены
- `KASPI_DELIVERY_RETURN_REQUESTED` - ожидает возврата
- `RETURNED` - возвращен

### Состояния заказов:
- `NEW` - новый
- `SIGN_REQUIRED` - нужно подписать документы
- `PICKUP` - самовывоз
- `DELIVERY` - ваша доставка
- `KASPI_DELIVERY` - Kaspi Доставка
- `ARCHIVE` - архивный

**Бот отслеживает заказы со статусами:**
- `NEW` - новые заказы
- `ACCEPTED_BY_MERCHANT` - принятые заказы

**И состояниями:**
- `NEW` - новый
- `DELIVERY` - ваша доставка  
- `KASPI_DELIVERY` - Kaspi Доставка

## Проблемы и решения

### Бот не реагирует на команду /start
1. ✅ **Исправлено**: Убран фильтр, блокирующий не-администраторов
2. Проверьте, что файл `.env` создан и содержит правильные значения
3. Убедитесь, что токен бота корректный

### Ошибки подключения к базе данных
1. ✅ **Исправлено**: Добавлена обработка ошибок подключения
2. Бот может работать без MongoDB
3. Проверьте настройки `MONGO_URI`

### Ошибки API Kaspi
1. ✅ **Исправлено**: Добавлена детальная обработка ошибок API
2. Проверьте настройки `KASPI_API`
3. Убедитесь, что API ключ действителен и имеет нужные права

### Нет уведомлений о заказах
1. Проверьте, что `KASPI_API` настроен правильно
2. Убедитесь, что у вас есть активные заказы в Kaspi
3. Проверьте логи бота на наличие ошибок API

## Логирование

Бот использует loguru для логирования. Все ошибки и предупреждения записываются в консоль с подробной информацией.

## Источники

- [Официальная документация Kaspi API](https://guide.kaspi.kz/partner/ru/shop/api/orders/q3201)
